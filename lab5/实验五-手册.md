## 基于鲲鹏虚拟化的大模型部署与测试

### 实验目的

1. 掌握libvirt虚拟化工具的基本使用：包括虚拟机的创建、配置修改、启动、连接和关闭，理解libvirt在虚拟机管理中的作用。
2.  学习开源模型BitNet b1.58的部署与推理：通过实际运行模型推理和性能测试，了解该模型的特点、应用场景及性能表现。
3. 实践虚拟机与宿主机之间的文件共享：通过配置共享目录，实现宿主机与虚拟机之间的数据交互。
4. 分析模型推理效果与性能：通过修改prompt观察模型输出变化，通过benchmark测试分析模型在不同参数下的性能表现。

### 调研环节

请在报告中回答以下问题：

1. 本次虚拟化工具使用libvirt软件，请调研该软件的背景、用途和基本工具集及使用方式，并阅读工作目录中的`kvm.xml`文件，给出此次实验中的虚拟机的基本信息（包括与主机的共享目录名）；
2. 本次使用的开源模型为BitNet b1.58，请调研该模型并给出较详细的基本信息。

### 实验环节

#### 实验说明

> 预先准备

为了不和其他用户创建的虚拟机冲突，有以下工作需要事先完成（==请注意下面的所有`testuser`必须均替换为你的用户名==，可以用`$ whoami`查看）。

- 首先，请你确认已启动并登录到机器中。
- 确保当前位于用户家目录，可看到当前目录下有文件`kvm.xml`,` openEuler-22.03-LTS-SP3-aarch64.qcow2`和主机虚拟机共享目录`shared`。

- 修改kvm.xml文件

```shell
vi kvm.xml
	修改name：将 openEulerVM 改为 openEulerVM-testuser
	修改os下的nvram: 将 openEulerVM.fd 改为 openEulerVM-testuser.fd
```

- 将虚拟机磁盘镜像移动到公共目录


```shell
# 创建镜像目录
sudo mkdir -p /var/lib/libvirt/images/testuser
sudo chown testuser:libvirt /var/lib/libvirt/images/testuser
sudo chmod 775 /var/lib/libvirt/images/testuser

# 移动镜像文件
sudo cp ~/openEuler-22.03-LTS-SP3-aarch64.qcow2 /var/lib/libvirt/images/testuser/

# 修改 XML 文件中的系统盘路径为：(放home目录会有qemu用户访问权限问题)
<source file='/var/lib/libvirt/images/testuser/openEuler-22.03-LTS-SP3-aarch64.qcow2'/>
```

- 移动虚拟机主机共享目录

```shell
sudo mkdir -p /var/lib/libvirt/shared/testuser
sudo chown testuser:libvirt /var/lib/libvirt/shared/testuser
sudo chmod 775 /var/lib/libvirt/shared/testuser

# 移动shared目录
sudo cp -r ~/shared /var/lib/libvirt/shared/testuser/

# 修改 XML 文件中的共享文件夹路径为：(放home目录会有qemu用户访问权限问题)
<source dir='/var/lib/libvirt/shared/testuser/shared'/>
```


> 虚拟机的创建和连接。
>
> 以下操作在宿主机上完成。
>
> 注意添加 sudo 命令。

- 确保你位于用户家目录下，目录中有 kvm.xml文件。

- 使用`$ virsh define kvm.xml`命令根据配置文件创建一个虚拟机。
- 使用`$ virsh list --all`可以看到已创建的虚拟机openEulerVM-testuser（==注意你创建的虚拟机名字并不叫这个==）。
- 开启虚拟机，使用`$ virsh start openEulerVM-testuser`命令，并在另一个终端界面（原终端界面用于开启和关闭虚拟机）使用`$ virsh console openEulerVM-testuser`访问该虚拟机，root用户的passwd为`mima`。

> 模型的部署和测试。
>
> 下面的操作步骤均在虚拟机中的系统完成。

- `$ pwd`确认当前工作目录为`/root`。
- 进入`BitNet`目录，该目录的内容基本来自于仓库`https://github.com/microsoft/BitNet.git`，详细内容请直接参考该仓库`main`分支的`README`。
- 虚拟机镜像中预装了miniconda软件，你可以查看当前的虚拟环境，并使用`$ conda activate bitnet-cpp`切换到实验用的虚拟环境。
- （项目的构建和模型权重的下载已经由助教预先完成，感兴趣的同学可以在自己的机器上尝试完整走一遍流程）模型参数已经存放至`models`目录下，可以直接运行`$ python run_inference.py -m models/BitNet-b1.58-2B-4T/ggml-model-i2_s.gguf -p "You are a helpful assistant" -cnv`进行推理demo的演示。
- 该项目也提供了一个简单的benchmark测试，运行`$ python utils/e2e_benchmark.py -m models/BitNet-b1.58-2B-4T/ggml-model-i2_s.gguf -n 200 -p 256 -t 4`观察效果（该步骤可能比较耗时，同学可与自己环境的运行时间对比）。

虚拟机的关闭：在虚拟机终端输入`exit`退出用户，然后在宿主机上运行`virsh shutdown openEulerVM-testuser`以关闭该虚拟机。

####  实验目标

以下内容均需在报告中呈现，包括运行截图。

- 尝试使用`virsh edit`命令在线修改虚拟机配置。
- 尝试修改给模型的prompt，输入同样的问题观察推理效果，并给出解释（如果有能力的话）。
- 分析benchmark程序的输出结果，尝试修改命令参数并给出分析。
- （可选）在自己的环境中部署和测试该模型，比较benchmark的测试结果并给出分析。

